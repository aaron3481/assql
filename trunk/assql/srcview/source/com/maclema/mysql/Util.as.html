<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Util.as</title>
<link rel="stylesheet" type="text/css" href="../../../../SourceStyles.css"/>
</head>

<body><pre><span class="asPackage">package</span> com.maclema.mysql
<span class="asBracket">{</span>
    <span class="asReserved">import</span> flash.utils.ByteArray;
    <span class="asReserved">import</span> com.adobe.crypto.SHA1;
    <span class="asReserved">import</span> mx.core.IDataRenderer;
    <span class="asReserved">import</span> flash.utils.IDataOutput;
    <span class="asReserved">import</span> flash.utils.IDataInput;
    
    <span class="asReserved">public</span> <span class="asClass">class</span> Util
    <span class="asBracket">{</span>
        <span class="asDoc">/**
         * Handles the new encryption for 4.1 and newer servers.
         **/</span>
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asFunction">function</span> newCrypt<span class="asBracket">(</span>password<span class="asOperator">:</span>String, seed<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span>String
        <span class="asBracket">{</span>
            <span class="asVar">var</span> i<span class="asOperator">:</span>int;
            <span class="asVar">var</span> b<span class="asOperator">:</span>Number;
            <span class="asVar">var</span> d<span class="asOperator">:</span>Number;
    
            <span class="asReserved">if</span> <span class="asBracket">((</span>password <span class="asOperator">==</span> <span class="asReserved">null</span><span class="asBracket">)</span> <span class="asOperator">||</span> <span class="asBracket">(</span>password.length <span class="asOperator">==</span> 0<span class="asBracket">))</span> 
            <span class="asBracket">{</span>
                <span class="asReserved">return</span> password;
            <span class="asBracket">}</span>
    
            <span class="asVar">var</span> pw<span class="asOperator">:</span>Array <span class="asOperator">=</span> newHash<span class="asBracket">(</span>seed<span class="asBracket">)</span>;
            <span class="asVar">var</span> msg<span class="asOperator">:</span>Array <span class="asOperator">=</span> newHash<span class="asBracket">(</span>password<span class="asBracket">)</span>;
            <span class="asVar">var</span> max<span class="asOperator">:</span>Number <span class="asOperator">=</span> 0x3fffffff;
            <span class="asVar">var</span> seed1<span class="asOperator">:</span>Number <span class="asOperator">=</span> <span class="asBracket">(</span>pw<span class="asBracket">[</span>0<span class="asBracket">]</span> <span class="asOperator">^</span> msg<span class="asBracket">[</span>0<span class="asBracket">])</span> <span class="asOperator">%</span> max;
            <span class="asVar">var</span> seed2<span class="asOperator">:</span>Number <span class="asOperator">=</span> <span class="asBracket">(</span>pw<span class="asBracket">[</span>1<span class="asBracket">]</span> <span class="asOperator">^</span> msg<span class="asBracket">[</span>1<span class="asBracket">])</span> <span class="asOperator">%</span> max;
            <span class="asVar">var</span> chars<span class="asOperator">:</span>Array <span class="asOperator">=</span> <span class="asReserved">new</span> Array<span class="asBracket">(</span>seed.length<span class="asBracket">)</span>;
    
            <span class="asReserved">for</span> <span class="asBracket">(</span>i <span class="asOperator">=</span> 0; i <span class="asOperator">&lt;</span> seed.length; i<span class="asOperator">++</span><span class="asBracket">)</span> 
            <span class="asBracket">{</span>
                seed1 <span class="asOperator">=</span> <span class="asBracket">((</span>seed1 <span class="asOperator">*</span> 3<span class="asBracket">)</span> <span class="asOperator">+</span> seed2<span class="asBracket">)</span> <span class="asOperator">%</span> max;
                seed2 <span class="asOperator">=</span> <span class="asBracket">(</span>seed1 <span class="asOperator">+</span> seed2 <span class="asOperator">+</span> 33<span class="asBracket">)</span> <span class="asOperator">%</span> max;
                d <span class="asOperator">=</span> seed1 <span class="asOperator">/</span> max;
                b <span class="asOperator">=</span> Math.floor<span class="asBracket">((</span>d <span class="asOperator">*</span> 31<span class="asBracket">)</span> <span class="asOperator">+</span> 64<span class="asBracket">)</span>;
                chars<span class="asBracket">[</span>i<span class="asBracket">]</span> <span class="asOperator">=</span> b;
            <span class="asBracket">}</span>
    
            seed1 <span class="asOperator">=</span> <span class="asBracket">((</span>seed1 <span class="asOperator">*</span> 3<span class="asBracket">)</span> <span class="asOperator">+</span> seed2<span class="asBracket">)</span> <span class="asOperator">%</span> max;
            seed2 <span class="asOperator">=</span> <span class="asBracket">(</span>seed1 <span class="asOperator">+</span> seed2 <span class="asOperator">+</span> 33<span class="asBracket">)</span> <span class="asOperator">%</span> max;
            d <span class="asOperator">=</span> seed1 <span class="asOperator">/</span> max;
            b <span class="asOperator">=</span> Math.floor<span class="asBracket">(</span>d <span class="asOperator">*</span> 31<span class="asBracket">)</span>;
    
            <span class="asReserved">for</span> <span class="asBracket">(</span>i <span class="asOperator">=</span> 0; i <span class="asOperator">&lt;</span> seed.length; i<span class="asOperator">++</span><span class="asBracket">)</span> 
            <span class="asBracket">{</span>
                chars<span class="asBracket">[</span>i<span class="asBracket">]</span> <span class="asOperator">^=</span> b;
            <span class="asBracket">}</span>
            
            <span class="asVar">var</span> ret<span class="asOperator">:</span>String <span class="asOperator">=</span> <span class="asString">&quot;&quot;</span>;
            
            <span class="asReserved">for</span> <span class="asBracket">(</span> i; i<span class="asOperator">&lt;</span>chars.length; i<span class="asOperator">++</span> <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                ret <span class="asOperator">+=</span> String.fromCharCode<span class="asBracket">(</span> chars<span class="asBracket">[</span>i<span class="asBracket">]</span> <span class="asBracket">)</span>;
            <span class="asBracket">}</span>
    
            <span class="asReserved">return</span> ret;
        <span class="asBracket">}</span>
        
        <span class="asReserved">private</span> <span class="asReserved">static</span> <span class="asFunction">function</span> newHash<span class="asBracket">(</span>password<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span>Array
        <span class="asBracket">{</span>
            <span class="asVar">var</span> nr<span class="asOperator">:</span>Number <span class="asOperator">=</span> 1345345333;
            <span class="asVar">var</span> add<span class="asOperator">:</span>Number <span class="asOperator">=</span> 7;
            <span class="asVar">var</span> nr2<span class="asOperator">:</span>Number <span class="asOperator">=</span> 0x12345671;
            <span class="asVar">var</span> tmp<span class="asOperator">:</span>Number;

            <span class="asReserved">for</span> <span class="asBracket">(</span><span class="asVar">var</span> i<span class="asOperator">:</span>int <span class="asOperator">=</span> 0; i <span class="asOperator">&lt;</span> password.length; <span class="asOperator">++</span>i<span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asReserved">if</span> <span class="asBracket">((</span>password.charAt<span class="asBracket">(</span>i<span class="asBracket">)</span> <span class="asOperator">==</span> <span class="asString">&apos; &apos;</span><span class="asBracket">)</span> <span class="asOperator">||</span> <span class="asBracket">(</span>password.charAt<span class="asBracket">(</span>i<span class="asBracket">)</span> <span class="asOperator">==</span> <span class="asString">&apos;\t&apos;</span><span class="asBracket">))</span> 
                <span class="asBracket">{</span>
                    <span class="asReserved">continue</span>; <span class="asComment">// skip spaces
</span>                <span class="asBracket">}</span>
    
                tmp <span class="asOperator">=</span> <span class="asBracket">(</span> 0xff <span class="asOperator">&amp;</span> password.charCodeAt<span class="asBracket">(</span>i<span class="asBracket">)</span> <span class="asBracket">)</span>;
                nr <span class="asOperator">^=</span> <span class="asBracket">((((</span>nr <span class="asOperator">&amp;</span> 63<span class="asBracket">)</span> <span class="asOperator">+</span> add<span class="asBracket">)</span> <span class="asOperator">*</span> tmp<span class="asBracket">)</span> <span class="asOperator">+</span> <span class="asBracket">(</span>nr <span class="asOperator">&lt;&lt;</span> 8<span class="asBracket">))</span>;
                nr2 <span class="asOperator">+=</span> <span class="asBracket">((</span>nr2 <span class="asOperator">&lt;&lt;</span> 8<span class="asBracket">)</span> <span class="asOperator">^</span> nr<span class="asBracket">)</span>;
                add <span class="asOperator">+=</span> tmp;
            <span class="asBracket">}</span>
            
            <span class="asVar">var</span> result<span class="asOperator">:</span>Array <span class="asOperator">=</span> <span class="asReserved">new</span> Array<span class="asBracket">(</span>2<span class="asBracket">)</span>;
            result<span class="asBracket">[</span>0<span class="asBracket">]</span> <span class="asOperator">=</span> nr <span class="asOperator">&amp;</span> 0x7fffffff;
            result<span class="asBracket">[</span>1<span class="asBracket">]</span> <span class="asOperator">=</span> nr2 <span class="asOperator">&amp;</span> 0x7fffffff;

            <span class="asReserved">return</span> result;
        <span class="asBracket">}</span>
        
        <span class="asDoc">/**
        * Handles the 4.1 or newer encryption
        **/</span>
        <span class="asReserved">public</span> <span class="asReserved">static</span> <span class="asFunction">function</span> scramble411<span class="asBracket">(</span>password<span class="asOperator">:</span>String, seed<span class="asOperator">:</span>String<span class="asBracket">)</span><span class="asOperator">:</span>ByteArray
        <span class="asBracket">{</span>
            <span class="asVar">var</span> passwordHashStage1<span class="asOperator">:</span>ByteArray <span class="asOperator">=</span> SHA1.hashToByteArray<span class="asBracket">(</span>password<span class="asBracket">)</span>;
            <span class="asVar">var</span> passwordHashStage2<span class="asOperator">:</span>ByteArray <span class="asOperator">=</span> SHA1.hashBytesToByteArray<span class="asBracket">(</span>passwordHashStage1<span class="asBracket">)</span>;
            
            passwordHashStage2.position<span class="asOperator">=</span>0;
            <span class="asVar">var</span> stage2string<span class="asOperator">:</span>String <span class="asOperator">=</span> passwordHashStage2.readUTFBytes<span class="asBracket">(</span>passwordHashStage2.bytesAvailable<span class="asBracket">)</span>;
            
            <span class="asVar">var</span> passwordHashStage3<span class="asOperator">:</span>ByteArray <span class="asOperator">=</span> SHA1.hashToByteArray<span class="asBracket">(</span>seed<span class="asOperator">+</span>stage2string<span class="asBracket">)</span>;
            
            <span class="asVar">var</span> toBeXord<span class="asOperator">:</span>ByteArray <span class="asOperator">=</span> <span class="asReserved">new</span> ByteArray<span class="asBracket">()</span>;
            
            <span class="asVar">var</span> numToXor<span class="asOperator">:</span>int <span class="asOperator">=</span> passwordHashStage3.length; 
            
            passwordHashStage3.position<span class="asOperator">=</span>0;
            passwordHashStage1.position<span class="asOperator">=</span>0;
            <span class="asReserved">for</span> <span class="asBracket">(</span> <span class="asVar">var</span> i<span class="asOperator">:</span>int<span class="asOperator">=</span>0; i<span class="asOperator">&lt;</span>numToXor; i<span class="asOperator">++</span> <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asVar">var</span> char1<span class="asOperator">:</span>int <span class="asOperator">=</span> passwordHashStage3.readByte<span class="asBracket">()</span>;
                <span class="asVar">var</span> char2<span class="asOperator">:</span>int <span class="asOperator">=</span> passwordHashStage1.readByte<span class="asBracket">()</span>;
                <span class="asVar">var</span> newChar<span class="asOperator">:</span>int <span class="asOperator">=</span> char1 <span class="asOperator">^</span> char2;
                
                toBeXord.writeByte<span class="asBracket">(</span>newChar<span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            
            toBeXord.position <span class="asOperator">=</span> 0;
            
            <span class="asReserved">return</span> toBeXord;
        <span class="asBracket">}</span>
    <span class="asBracket">}</span>
<span class="asBracket">}</span></pre></body>
</html>
