<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>HandshakeHandler.as</title>
<link rel="stylesheet" type="text/css" href="../../../../SourceStyles.css"/>
</head>

<body><pre><span class="asPackage">package</span> com.maclema.mysql
<span class="asBracket">{</span>
    <span class="asReserved">import</span> flash.events.Event;
    <span class="asReserved">import</span> flash.net.Socket;
    <span class="asReserved">import</span> flash.utils.ByteArray;
    
    <span class="asDoc">/**
     * This class handles completing the handshake between this driver
     * and the mysql server
     **/</span>
    <span class="asReserved">public</span> <span class="asClass">class</span> HandshakeHandler <span class="asReserved">extends</span> DataHandler
    <span class="asBracket">{</span>
        <span class="asReserved">private</span> <span class="asVar">var</span> username<span class="asOperator">:</span>String;
        <span class="asReserved">private</span> <span class="asVar">var</span> password<span class="asOperator">:</span>String;
        <span class="asReserved">private</span> <span class="asVar">var</span> database<span class="asOperator">:</span>String;
        
        <span class="asReserved">private</span> <span class="asVar">var</span> connectWithDb<span class="asOperator">:</span>Boolean <span class="asOperator">=</span> <span class="asReserved">false</span>;
        
        <span class="asReserved">private</span> <span class="asVar">var</span> inPacketCount<span class="asOperator">:</span>int <span class="asOperator">=</span> 0;
        
        <span class="asReserved">public</span> <span class="asFunction">function</span> HandshakeHandler<span class="asBracket">(</span>con<span class="asOperator">:</span>Connection, username<span class="asOperator">:</span>String, password<span class="asOperator">:</span>String, database<span class="asOperator">:</span>String<span class="asBracket">)</span>
        <span class="asBracket">{</span>
            <span class="asReserved">super</span><span class="asBracket">(</span>con<span class="asBracket">)</span>;
            
            <span class="asReserved">this</span>.username <span class="asOperator">=</span> username;
            <span class="asReserved">this</span>.password <span class="asOperator">=</span> password;
            <span class="asReserved">this</span>.database <span class="asOperator">=</span> database;
        <span class="asBracket">}</span>
        
        <span class="asReserved">override</span> <span class="asReserved">protected</span> <span class="asFunction">function</span> newPacket<span class="asBracket">()</span><span class="asOperator">:</span><span class="asReserved">void</span>
        <span class="asBracket">{</span>
            inPacketCount<span class="asOperator">++</span>;
            
            <span class="asReserved">if</span> <span class="asBracket">(</span> inPacketCount <span class="asOperator">==</span> 1 <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                con.server <span class="asOperator">=</span> <span class="asReserved">new</span> ServerInformation<span class="asBracket">(</span> nextPacket<span class="asBracket">()</span> <span class="asBracket">)</span>;
                doHandshake<span class="asBracket">()</span>;
            <span class="asBracket">}</span>
            <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span> inPacketCount <span class="asOperator">==</span> 2 <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asVar">var</span> packet<span class="asOperator">:</span>Packet <span class="asOperator">=</span> nextPacket<span class="asBracket">()</span>;
                <span class="asVar">var</span> field_count<span class="asOperator">:</span>int <span class="asOperator">=</span> packet.readByte<span class="asBracket">()</span> <span class="asOperator">&amp;</span> 0xFF;
                
                <span class="asReserved">if</span> <span class="asBracket">(</span> field_count <span class="asOperator">==</span> 0x00 <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    <span class="asComment">//ok packet
</span>                    
                    <span class="asReserved">if</span> <span class="asBracket">(</span> connectWithDb <span class="asBracket">)</span>
                    <span class="asBracket">{</span>
                        <span class="asComment">//send command
</span>                        con.changeDatabaseTo<span class="asBracket">(</span>database<span class="asBracket">)</span>;
                    <span class="asBracket">}</span>
                    <span class="asReserved">else</span>
                    <span class="asBracket">{</span>
                        <span class="asComment">//woop! were authenticated
</span>                        unregister<span class="asBracket">()</span>;
                        con.dispatchEvent<span class="asBracket">(</span><span class="asReserved">new</span> Event<span class="asBracket">(</span>Event.CONNECT<span class="asBracket">))</span>;
                    <span class="asBracket">}</span>
                <span class="asBracket">}</span>
                <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span> field_count <span class="asOperator">==</span> 0xFF <span class="asOperator">||</span> field_count <span class="asOperator">==</span> <span class="asOperator">-</span>1 <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    unregister<span class="asBracket">()</span>;
                    <span class="asReserved">new</span> ErrorHandler<span class="asBracket">(</span> packet, con <span class="asBracket">)</span>;
                <span class="asBracket">}</span>
            <span class="asBracket">}</span>
            <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span> connectWithDb <span class="asOperator">&amp;&amp;</span> inPacketCount <span class="asOperator">==</span> 3 <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asVar">var</span> packet<span class="asOperator">:</span>Packet <span class="asOperator">=</span> nextPacket<span class="asBracket">()</span>;
                <span class="asVar">var</span> field_count<span class="asOperator">:</span>int <span class="asOperator">=</span> packet.readByte<span class="asBracket">()</span> <span class="asOperator">&amp;</span> 0xFF;
                
                <span class="asReserved">if</span> <span class="asBracket">(</span> field_count <span class="asOperator">==</span> 0x00 <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    <span class="asComment">//woop! were authenticated
</span>                    unregister<span class="asBracket">()</span>;
                    con.dispatchEvent<span class="asBracket">(</span><span class="asReserved">new</span> Event<span class="asBracket">(</span>Event.CONNECT<span class="asBracket">))</span>;
                <span class="asBracket">}</span>
                <span class="asReserved">else</span> <span class="asReserved">if</span> <span class="asBracket">(</span> field_count <span class="asOperator">==</span> 0xFF <span class="asOperator">||</span> field_count <span class="asOperator">==</span> <span class="asOperator">-</span>1 <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    unregister<span class="asBracket">()</span>;
                    <span class="asReserved">new</span> ErrorHandler<span class="asBracket">(</span> packet, con <span class="asBracket">)</span>;
                <span class="asBracket">}</span>
            <span class="asBracket">}</span>
        <span class="asBracket">}</span>
        
        <span class="asReserved">private</span> <span class="asFunction">function</span> doHandshake<span class="asBracket">()</span><span class="asOperator">:</span><span class="asReserved">void</span>
        <span class="asBracket">{</span>
            <span class="asReserved">if</span> <span class="asBracket">(</span> con.server.meetsVersion<span class="asBracket">(</span> 4, 1, 22 <span class="asBracket">)</span> <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asReserved">if</span> <span class="asBracket">(</span> database <span class="asOperator">!=</span> <span class="asReserved">null</span> <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_CONNECT_WITH_DB;
                    connectWithDb <span class="asOperator">=</span> <span class="asReserved">true</span>;
                <span class="asBracket">}</span>
                
                <span class="asReserved">if</span> <span class="asBracket">(</span> con.server.isCapableOf<span class="asBracket">(</span> Mysql.CLIENT_LONG_FLAG <span class="asBracket">)</span> <span class="asBracket">)</span>
                <span class="asBracket">{</span>
                    con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_LONG_FLAG;
                    con.hasLongColumnInfo <span class="asOperator">=</span> <span class="asReserved">true</span>;
                <span class="asBracket">}</span>
                
                <span class="asComment">//return found rows
</span>                con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_FOUND_ROWS;
    
                <span class="asComment">//use the new password encryption
</span>                con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_LONG_PASSWORD;
                
                <span class="asComment">//use the 4.1.1 protocol
</span>                con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_PROTOCOL_41;
                
                <span class="asComment">//use transactions
</span>                con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_TRANSACTIONS;
                
                <span class="asComment">//return multiple result sets
</span>                con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_MULTI_RESULTS;
                
                <span class="asComment">//For some reason this check always fails and you get a NotImplementedError.. need to fix before
</span>                <span class="asComment">//I can support the old password hashing.
</span>                <span class="asComment">//do secure authentication?
</span>                <span class="asComment">//if ( server.isCapableOf( Mysql.CLIENT_SECURE_CONNECTION ) )
</span>                <span class="asComment">//{
</span>                    con.clientParam <span class="asOperator">|=</span> Mysql.CLIENT_SECURE_CONNECTION;
                    doSecureAuthentication<span class="asBracket">()</span>;
                <span class="asComment">//}    
</span>                <span class="asComment">//else
</span>                <span class="asComment">//{
</span>                <span class="asComment">//    throw new NotImplementedError(&quot;Currently only connecting with the new &apos;long password&apos; is supported&quot;);
</span>                <span class="asComment">//}
</span>            <span class="asBracket">}</span>
            <span class="asReserved">else</span>
            <span class="asBracket">{</span>
                <span class="asReserved">throw</span> <span class="asReserved">new</span> Error<span class="asBracket">(</span><span class="asString">&quot;Unsupported Server Version&quot;</span><span class="asBracket">)</span>;
            <span class="asBracket">}</span>
        <span class="asBracket">}</span>
        
        <span class="asComment">/* completes the authentication */</span>
        <span class="asReserved">private</span> <span class="asFunction">function</span> doSecureAuthentication<span class="asBracket">()</span><span class="asOperator">:</span><span class="asReserved">void</span>
        <span class="asBracket">{</span>
            <span class="asComment">//the packet to send
</span>            <span class="asVar">var</span> packet<span class="asOperator">:</span>Packet <span class="asOperator">=</span> <span class="asReserved">new</span> Packet<span class="asBracket">()</span>;
            
            <span class="asComment">//write the client parameters
</span>            packet.writeInt<span class="asBracket">(</span> con.clientParam <span class="asBracket">)</span>;
            
            <span class="asComment">// write the maximum packet sixe
</span>            packet.writeInt<span class="asBracket">(</span> Packet.maxThreeBytes <span class="asBracket">)</span>;
            
            <span class="asComment">//language
</span>            packet.writeByte<span class="asBracket">(</span> 8 <span class="asBracket">)</span>; <span class="asComment">//charset
</span>            
            <span class="asComment">//the 23-byte null filler
</span>            packet.writeNullBytes<span class="asBracket">(</span>23<span class="asBracket">)</span>;
            
            <span class="asComment">//the username
</span>            packet.writeString<span class="asBracket">(</span>username<span class="asBracket">)</span>;
            
            <span class="asReserved">if</span> <span class="asBracket">(</span> password <span class="asOperator">!=</span> <span class="asReserved">null</span> <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                <span class="asVar">var</span> scrambledPassword<span class="asOperator">:</span>ByteArray <span class="asOperator">=</span> Util.scramble411<span class="asBracket">(</span> password, con.server.seed <span class="asBracket">)</span>;
                packet.writeBytes<span class="asBracket">(</span>scrambledPassword<span class="asBracket">)</span>;    
            <span class="asBracket">}</span>
            <span class="asReserved">else</span>
            <span class="asBracket">{</span>
                <span class="asComment">//empty password
</span>                packet.writeByte<span class="asBracket">(</span>0x00<span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            
            <span class="asComment">//another null filler
</span>            packet.writeByte<span class="asBracket">(</span>0x00<span class="asBracket">)</span>; <span class="asComment">//filler
</span>            
            <span class="asComment">//are we connecting using a database name?
</span>            <span class="asReserved">if</span> <span class="asBracket">(</span> connectWithDb <span class="asOperator">&amp;&amp;</span> database <span class="asOperator">!=</span> <span class="asReserved">null</span> <span class="asBracket">)</span>
            <span class="asBracket">{</span>
                packet.writeString<span class="asBracket">(</span>database<span class="asBracket">)</span>;
            <span class="asBracket">}</span>
            
            <span class="asComment">//send the packet. For some reason the handshake packet secuence needs to 
</span>            <span class="asComment">//start at 1 rather then 0 like the rest of the packets, so we can specify
</span>            <span class="asComment">//that here.
</span>            packet.send<span class="asBracket">(</span>con.getSocket<span class="asBracket">()</span>, 1<span class="asBracket">)</span>;
        <span class="asBracket">}</span>
    <span class="asBracket">}</span>
<span class="asBracket">}</span></pre></body>
</html>
